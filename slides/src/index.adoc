= Type Driven User Interfaces: with [.yellow]#Qt# and [.yellow]#C++#
:author: Andreas Reischuck
:twitter: @arBmind
:!avatar: andreas.png
:!organization: HicknHack Software GmbH
:!sectids:
:imagesdir: images
:icons: font
:use-link-attrs:
:title-separator: :
:codedir: code
:data-uri:

*Qt World Summit 2019 Berlin*

++++
<svg class="overlay build" viewBox="0 0 1280 720" width="1920" height="1080">
    <g transform="translate(610,260) scale(3) rotate(10)">
        <text class="cppVersion build" x="0" y="0">17</text>
    </g>
</svg>
++++

[.cue]
****
Welcome

Goals of this talk:

* Go play with C++ / hacken?
* Increase understanding - What is what?
* Not Important - Use this next week.

Hopefully for everybody I have something unknown!
****


== Distributed System

[%build]
* complex!
* (note: simplified for slides!)

== !

++++
<!-- for editing help:
 * https://editor.method.ac
 * https://svg-edit.github.io/svgedit/releases/latest/editor/svg-editor.html
-->
<svg class="build" viewBox="0 0 1280 720" width="1920" height="1080">
    <defs>
        <filter id="dropshadow" height="130%" width="130%">
            <feGaussianBlur in="SourceAlpha" stdDeviation="5"/>
            <feOffset dx="0" dy="0" result="offsetblur"/>
            <feComponentTransfer>
                <feFuncA type="linear" slope="0.5"/>
            </feComponentTransfer>
            <feMerge> 
                <feMergeNode/>
                <feMergeNode in="SourceGraphic"/>
            </feMerge>
        </filter>
        <rect id="activeRect" x="2%" y="2%" width="96%" height="96%" fill="#fff" rx="20" ry="20" fill-opacity="0" stroke="#41CD52" stroke-width="15" />
        <filter id="activeMarker" filterUnits="objectBoundingBox">
            <feImage xlink:href="#activeRect" preserveAspectRatio="none" />
            <feMerge> 
                <feMergeNode />
                <feMergeNode in="SourceGraphic"/>
            </feMerge>
        </filter>
    </defs>
    <g class="clientMonitor" transform="translate(350,180) scale(1.5)">
        <g class="build">
            <path class="UserScreen" style="filter:url(#dropshadow)" 
                fill="#fff8dc" stroke="#222" stroke-width="1.33"
                d="M-100,-60 h200 v120 h-200 z
                m4,6 v108 h192 v-108 z
                M-110,80 h5 
                    v-3 h12 v3 h3 
                    v-3 h7 v3 h3 
                    v-3 h7 v3 h3 
                    v-3 h7 v3 h3 
                    v-3 h7 v3 h3 
                    v-3 h7 v3 h3 
                    v-3 h7 v3 h3 
                    v-3 h7 v3 h3 
                    v-3 h7 v3 h3 
                    v-3 h7 v3 h3 
                    v-3 h7 v3 h3 
                    v-3 h7 v3 h3 
                    v-3 h12 v3 
                    h5 v5 H-110 z
                M60,70 h30 v30 c0,7 -7,15 -15,15 c-8,0 -15,-8 -15,-15 z m15,0 v15"/>

            <path class="UserScreenContent"
                fill="#222" d="M-100,-60 m4,6 v108 h192 v-108 z"/>
        </g>

        <path class="UserSmiley build"
            fill="#ddc" stroke="#222" stroke-width="0.66"
            d="M0,-20 a20,20 0,0,0, 0,40 a20,20 0,0,0, 0,-40z 
                m-15,25 a16,10 0,0,0, 30,0
                m-7,-13 a3,3 0,1,0, 1,0 z
                m-16,0 a3,3 0,1,0, 1,0 z
                m8,-7 l8,-10 m-9,10 l2,-9"
            transform="translate(-110,-60) scale(2)" />

        <g class="build">
            <path class="ActionButton"
                fill="#acf" stroke="#fff" stroke-width="2"
                d="M-85,-22
                    a6,6 0,0,1 6,-6 h160 
                    a6,6 0,0,1 6,6 v40
                    a6,6 0,0,1 -6,6 h-160
                    a6,6 0,0,1 -6,-6 z" />
            <text class="ActionText" x="0" y="0">Action</text>
            <path class="MouseCursor"
                fill="#fff" stroke="#222"
                d="M0,0 l10,17 l-7,-2 l3,10 h-12 l3,-10 l-7,2 z"
                transform="translate(45,5) rotate(-40) scale(2)" />
        </g>
    </g>

    <g class="command build" transform="translate(700,140)">
        <path class="commandArrow" style="filter:url(#dropshadow)"
            fill="#fca" stroke="#222" stroke-width="2"
            d="M-150,0
                c-1,-1.66 -.66,-5 1,-6
                c30,-20 145,-60 200,-50
                c2.5,.5 5,-2.5 5,-5 v-30
                c0,-5 3,-8 15,0 l120,80
                c3,2 3,6 0,8 l-120,80
                c-12,8 -15,5 -15,0 v-30
                c0,-2.5 -1,-5 -4.5,-6
                c-53,-7 -120,20 -150,40
                c-1.66,1 -4,.33 -5,-1.33 z"
            transform="rotate(8)" />
        <text class="commandText" x="0" y="0">Command</text>
    </g>

    <g class="server build" transform="translate(1050,150)">
        <path class="ServerBox" style="filter:url(#dropshadow)"
            fill="#fff8dc" stroke="#222" stroke-width="1"
            d="M-65,-25 h130 v100 h-130 z
                l15,-15 h130 v100 l-15,15
                m0,-100 l15,-15"
            transform="scale(2)" />

        <path class="ServerFilter build"
            fill="#acf" stroke="#222" stroke-width="2"
            d="M-30,-30
                a30,10 0,0,1 60,0 v10 l-25,25 v30 l-10,-10 v-20 l-25,-25 z
                m5,0 a25,6 0,0,0 50,0 a25,6 0,0,0 -50,0"
            transform="translate(-60,80)" />

        <path class="ServerStorage build"
            fill="#acf" stroke="#222" stroke-width="2"
            d="M-30,-30 
                a30,10 0,0,1 60,0 v60 
                a30,10 0,0,1 -60,0 z
               m60,0 a30,10 0,0,1 -60,0
               m60,15 a30,10 0,0,1 -60,0
               m60,15 a30,10 0,0,1 -60,0
               m60,15 a30,10 0,0,1 -60,0"
            transform="translate(60,80)" />

        <text class="ServerText" x="0" y="0">Server</text>
    </g>

    <g class="events build" transform="translate(1100, 450)">
        <path class="commandArrow" style="filter:url(#dropshadow)"
            fill="#fca" stroke="#222" stroke-width="2"
            d="M-150,0
                c-1,-1.66 -.66,-5 1,-6
                c30,-20 145,-60 200,-50
                c2.5,.5 5,-2.5 5,-5 v-30
                c0,-5 3,-8 15,0 l120,80
                c3,2 3,6 0,8 l-120,80
                c-12,8 -15,5 -15,0 v-30
                c0,-2.5 -1,-5 -4.5,-6
                c-53,-7 -120,20 -150,40
                c-1.66,1 -4,.33 -5,-1.33 z"
            transform="rotate(140)" />
        
        <text class="commandText" x="-50" y="40">Events</text>
    </g>

    <g class="compute build" transform="translate(825, 575)">
        <path class="ComputeBox" style="filter:url(#dropshadow)"
            fill="#fff8dc" stroke="#222" stroke-width="2"
            d="M-120,-80 h240 v160 h-240 z" />
        <path class="ComputeSum"
            fill="#acf" stroke="#222" stroke-width="3"
            d="M-55,-65
                h100 l10,40 h-7 l-3,-5 c-8,-14 -10,-20 -32,-20 h-50
                l45,45 l-40,40
                h45 c12,0 24,-4 32,-20 l3,-5 h7 l-12,50 h-98
                v-15 l40,-40 l-40,-40 z"
            transform="scale(0.66) translate(0,30)" />
        
        <text class="ViewText" x="0" y="-50">Computations</text>
    </g>

    <g class="updates build" transform="translate(530, 500)">
        <path class="commandArrow" style="filter:url(#dropshadow)" 
            fill="#fca" stroke="#222" stroke-width="2"
            d="M-150,0
                c-1,-1.66 -.66,-5 1,-6
                c30,-20 145,-60 200,-50
                c2.5,.5 5,-2.5 5,-5 v-30
                c0,-5 3,-8 15,0 l120,80
                c3,2 3,6 0,8 l-120,80
                c-12,8 -15,5 -15,0 v-30
                c0,-2.5 -1,-5 -4.5,-6
                c-53,-7 -120,20 -150,40
                c-1.66,1 -4,.33 -5,-1.33 z"
            transform="scale(-1,1) rotate(0)" />
        
        <text class="commandText" x="-20" y="0">Updates</text>
    </g>

    <g class="views build" transform="translate(170, 550) scale(1.5)">
        <path class="ViewScreen" style="filter:url(#dropshadow)"
            fill="#fff8dc" stroke="#222" stroke-width="1.33"
            d="M-100,-60 h200 v120 h-200 z
               m4,6 v108 h192 v-108 z
               M-5,60 v10 h-20 v5 h50 v-5 h-20 v-10 z"/>

        <path class="ViewScreenContent"
            fill="#222" d="M-100,-60 m4,6 v108 h192 v-108 z"/>

        <path class="ViewTree build"
            fill="#222" stroke="#fff" stroke-width="2.5"
            d="M-50,-50
                m3,0 h10 a3,3 0,0,1 3,3 v10 a3,3 0,0,1 -3,3 h-10 a3,3 0,0,1 -3,-3 v-10 a3,3 0,0,1 3,-3 z
                m0,8 h10
                m10,-6 h60 v12 h-60 z
               M-42,-30 v12 m0,5 v12 m0,5 v12 m0,5 v8 h10
                m5,-8 h10 a3,3 0,0,1 3,3 v10 a3,3 0,0,1 -3,3 h-10 a3,3 0,0,1 -3,-3 v-10 a3,3 0,0,1 3,-3 z
                m0,8 h10 m-5,-5 v10
                m15,-11 h35 v12 h-35 z
               M-42,-24 h10
                m5,-8 h10 a3,3 0,0,1 3,3 v10 a3,3 0,0,1 -3,3 h-10 a3,3 0,0,1 -3,-3 v-10 a3,3 0,0,1 3,-3 z
                m0,8 h10
                m10,-6 h30 v12 h-30 z
               M-22,-12 v12 m0,5 v7 h10
                m5,-6 h25 v12 h-25 z
               M-22,-6 h10
                m5,-6 h40 v12 h-40 z"
            transform="translate(-40,5) scale(0.9)" />

        <path class="ViewGraph build"
            fill="#222" stroke="#fff" stroke-width="2.5"
            d="M-40,40 v-50 h20 v50 z
               m25,0 v-70 h20 v70 z
               m25,0 v-60 h20 v60 z"
            transform="translate(50,0)" />
        
        <text class="ViewText" x="0" y="-90">Views</text>
    </g>

</svg> 
++++

[.section]
== How can we design this?

[%build]
* data flow is clear
* ensure data compatibility
* communicate with developers


[.subtitle]
== Strong Types

[.cue]
****
* Let's begin at the bottom

Why strong types?
****


[.source.hd]
== !

[source, cpp, subs=quotes,macros]
----
struct Point {
    double x;
    double y;
    double z;
};
----

[.source.hd]
== !

[source%nested, cpp]
----
struct Point {
    double x;
    double y;
    double z;
    // nest++
    double weight;
    // nest--
};
----

[.source.hd]
== !

[source%nested, cpp]
----
struct Point {
    double x;
    double y;
    double z;
    double weight;
    // nest++
    double texX;
    double texY;
    // nest--
};
----

[.source.hd]
== !

[.build]
--
[source%nested, cpp, subs=quotes,macros]
----
struct X { double v{}; };
// nest++
struct Y { double v{}; };
struct Z { double v{}; };
// nest--

// nest++
struct Point {
    [.token.class-name]##X## x;
    [.token.class-name]##Y## y;
    [.token.class-name]##Z## z;
};
// nest--
----
--


[.source.hd]
== !

[source%nested, cpp, subs=quotes,macros]
----
struct X { double v{}; };
struct Y { double v{}; };
struct Z { double v{}; };

// nest++
using [.token.class-name]##Point## = std::tuple&lt;[.token.class-name]##X##, [.token.class-name]##Y##, [.token.class-name]##Z##>;
// nest--
----


[.source]
== !

[.build]
--
[source%nested, cpp, subs=quotes,macros]
----
// nest++
template&lt;class V, class /\*Tag*/ >
// nest--
struct Strong {
    // nest++
    [.token.class-name]##V## v{};
    // nest--
};
----
--

[.cue]
****
* The template signature: base type and any amount of tags
* Inside we store just the value

You might want to add operators, but that's enough for this talk.

If you want to learn more about strong types…
****


== !

image::BarneyDellar_StrongTypes_CppOnSea.png[role="center", width="1280"]

link:https://www.youtube.com/watch?v=fWcnp7Bulc8[Strong Types in C\++ - Barney Dellar [C++ on Sea 2019]]

[.cue]
****
There are a lot of good talks and blog posts.

If you want to stick to standard take a look at <chronos>.

****


[.source.hd]
== !

[.build]
--
[source%nested, cpp, subs=quotes,macros]
----
using [.token.string]##X## = [.token.class-name]##Strong##&lt;double, struct XTag>;
// nest++
using [.token.string]##Y## = [.token.class-name]##Strong##&lt;double, struct YTag>;
using [.token.string]##Z## = [.token.class-name]##Strong##&lt;double, struct ZTag>;
// nest--

// nest++
struct Point {
    [.token.string]##X## x;
    [.token.string]##Y## y;
    [.token.string]##Z## z;
};
// nest--
----
--


[.cue]
****
* So we use our strong type
* Build the tag type just in place
* They are just to make each type different
****

[.source.hd]
== !

[source%nested, cpp, subs=quotes,macros]
----
using [.token.string]##X## = [.token.class-name]##Strong##&lt;double, struct XTag>;
using [.token.string]##Y## = [.token.class-name]##Strong##&lt;double, struct YTag>;
using [.token.string]##Z## = [.token.class-name]##Strong##&lt;double, struct ZTag>;

// nest++
using [.token.class-name]##Point## = std::tuple&lt;[.token.string]##X##, [.token.string]##Y##, [.token.string]##Z##>;
// nest--
----


[.cue]
****
* Tuple is an implementation that stores all our values

If we design our distributed system, we do not really care about storage details.
A network protocol will use something different to transport the data.
****

[.source.hd]
== !

[source%nested, cpp, subs=quotes,macros]
----
using [.token.string]##X## = [.token.class-name]##Strong##&lt;double, struct XTag>;
using [.token.string]##Y## = [.token.class-name]##Strong##&lt;double, struct YTag>;
using [.token.string]##Z## = [.token.class-name]##Strong##&lt;double, struct ZTag>;

// nest++
using [.token.class-name]##Point## = [.token.bold]##AllOf##&lt;[.token.string]##X##, [.token.string]##Y##, [.token.string]##Z##>;
// nest--
----

[.cue]
****
* So we name it AllOf
* We describe that all of the types have to be stored or transmitted.
****


[.subtitle]
== Data Schema

[.cue]
****
Let's call this a data schema.

That's nothing new…
****

== Existing Data Schemas

[%build]
* XML schema
* JSON schema
* data definition language (DDL)

[.cue]
****
Schemas are everywhere.

They describe how our data is organised
These are essential part of a distributed system.

* We can derive how to store our data
* And we can derive how to communicate
****


[.source]
== !

[.build]
--
[source%nested, cpp, subs=quotes,macros]
----
using [.token.class-name]##Point## = [.token.bold]##AllOf##&lt;[.token.string]##X##, [.token.string]##Y##, [.token.string]##Z##>;
// nest++
using [.token.class-name]##Points## = [.token.bold]##SequenceOf##&lt;[.token.class-name]##Point##>;
// nest--

// nest++
using [.token.class-name]##Geometry## = [.token.bold]##AllOf##&lt;[.token.class-name]##Points##, [.token.class-name]##Faces##, [.token.class-name]##Shaders##>;
// nest--
// nest++
using [.token.class-name]##Object## = [.token.bold]##OneOf##&lt;[.token.class-name]##Geometry##, [.token.class-name]##Light##, [.token.class-name]##Camera##>;
// nest--
// nest++
using [.token.class-name]##Scene## = [.token.bold]##Hierarchy##&lt;[.token.string]##ObjectId##, [.token.class-name]##Object##>;
// nest--

// nest++
using [.token.class-name]##Document## = [.token.bold]##AllOf##&lt;[.token.string]##Name##, [.token.class-name]##Scene##>;
// nest--
// nest++
using [.token.class-name]##Documents## = [.token.bold]##EntitySet##&lt;[.token.string]##DocId##, [.token.class-name]##Document##>;
// nest--
----
--

== !

image::DocumentsSchema/Slide1.png[role="center", width="1920"]
== !

image::DocumentsSchema/Slide2.png[role="center", width="1920"]
== !

image::DocumentsSchema/Slide3.png[role="center", width="1920"]
== !

image::DocumentsSchema/Slide4.png[role="center", width="1920"]
== !

image::DocumentsSchema/Slide5.png[role="center", width="1920"]
== !

image::DocumentsSchema/Slide6.png[role="center", width="1920"]
== !

image::DocumentsSchema/Slide7.png[role="center", width="1920"]


== !

image::Geburtstag.jpg[role="center", width="1920"]

[.cue]
****
We have now everything to try this with C++ and Qt

* Strong Types
* Distributed System: Commands, Events, Protocols,
* data schema
****


[.subtitle]
== Schema with C++ types

[.cue]
****
Let's start with the basics.

How can we express our data schema in C++.
****

[.source.hd]
== !

[.build]
--
[source%nested, cpp, subs=quotes,macros]
----
// recursive schema primitives:
// nest++
template&lt;class...> struct [.token.black.bold]##AllOf## {};
// nest--
// nest++
template&lt;class...> struct [.token.black.bold]##OneOf## {};
// nest--
// nest++
template&lt;class> struct [.token.black.bold]##SequenceOf## {};
// nest--

// nest++
template&lt;class [.token.string]##Id##, class>
struct [.token.black.bold]##EntitySet## {};
// nest--
// nest++
template&lt;class [.token.string]##Id##, class>
struct [.token.black.bold]##Hierarchy## {};
// nest--
----
--

[.cue]
****
Notice these are all empty structures.

Our hierarchy is customized to our special needs.

How do we make use of this schema if everything is just empty?
****

== Type driven [.green]#Code# generation

[.canvas]
image::grandValleyCattleDrive.jpg[]

[.source.hd]
== !

[source, cpp, subs=quotes,macros]
----
&nbsp;
&nbsp;
&nbsp;
&nbsp;
&nbsp;
[.token.bold]##AllOf##&lt;...>
    -> std::tuple&lt;...>;
----

[.source.hd]
== !

[source%nested, cpp, subs=quotes,macros]
----
&nbsp;
&nbsp;
&nbsp;
&nbsp;
// nest++
template&lt;class... Ts>
// nest--
[.token.bold]##AllOf##&lt;Ts...>
    -> std::tuple&lt;...>;
----

[.source.hd]
== !

[source%nested, cpp, subs=quotes,macros]
----
&nbsp;
&nbsp;
&nbsp;
&nbsp;
template&lt;class... Ts>
// nest++
[.token.class-name]##StorageFor##([.token.bold]##AllOf##&lt;Ts...>)
// nest--
    -> std::tuple&lt;...>;
----

[.source.hd]
== !

[source%nested, cpp, subs=quotes,macros]
----
&nbsp;
&nbsp;
&nbsp;
&nbsp;
template&lt;class... Ts>
[.token.class-name]##StorageFor##([.token.bold]##AllOf##&lt;Ts...>)
// nest++
    -> std::tuple&lt;[.token.class-name]##StorageFor##&lt;Ts>...>;
// nest--
----

[.source.hd]
== !

[source%nested, cpp, subs=quotes,macros]
----
// nest++
template&lt;class [.token.black]##T##>
using [.token.class-name]##StorageFor## =
    decltype(storageFor([.token.constant]##adl##, [.token.constant]##ptr##&lt;T>));
// nest--
&nbsp;
template&lt;class... Ts>
// nest++
auto storageFor([.token.class-name]##ADL##, [.token.bold]##AllOf##&lt;Ts...> *)
// nest--
    -> std::tuple&lt;[.token.class-name]##StorageFor##&lt;Ts>...>;
----


[.cue]
****
We introduce a using retrieve the result type of our function.

To make this recursion work, we need ADL.

Normally a templated function only sees what was defined before the function.
ADL overrides this and adds everything of our namespace anyways.

* adl is a constexpr instance of ADL.
* ptr<T> is a constexpr nullptr to T.

This ensures the compiler wont instantiate any complex types.

Our functon signature changed accordingly.
****

== Let us generate everything!


== !


++++
<!-- for editing help:
 * https://editor.method.ac
 * https://svg-edit.github.io/svgedit/releases/latest/editor/svg-editor.html
-->
<svg class="" viewBox="0 0 1280 720" width="1920" height="1080">

    <g class="clientMonitor" transform="translate(350,180) scale(1.5)">
        <g class="">
            <path class="UserScreen" style="filter:url(#dropshadow)" 
                fill="#fff8dc" stroke="#222" stroke-width="1.33"
                d="M-100,-60 h200 v120 h-200 z
                m4,6 v108 h192 v-108 z
                M-110,80 h5 
                    v-3 h12 v3 h3 
                    v-3 h7 v3 h3 
                    v-3 h7 v3 h3 
                    v-3 h7 v3 h3 
                    v-3 h7 v3 h3 
                    v-3 h7 v3 h3 
                    v-3 h7 v3 h3 
                    v-3 h7 v3 h3 
                    v-3 h7 v3 h3 
                    v-3 h7 v3 h3 
                    v-3 h7 v3 h3 
                    v-3 h7 v3 h3 
                    v-3 h12 v3 
                    h5 v5 H-110 z
                M60,70 h30 v30 c0,7 -7,15 -15,15 c-8,0 -15,-8 -15,-15 z m15,0 v15"/>

            <path class="UserScreenContent"
                fill="#222" d="M-100,-60 m4,6 v108 h192 v-108 z"/>
        </g>

        <path class="UserSmiley"
            fill="#ddc" stroke="#222" stroke-width="0.66"
            d="M0,-20 a20,20 0,0,0, 0,40 a20,20 0,0,0, 0,-40z 
                m-15,25 a16,10 0,0,0, 30,0
                m-7,-13 a3,3 0,1,0, 1,0 z
                m-16,0 a3,3 0,1,0, 1,0 z
                m8,-7 l8,-10 m-9,10 l2,-9"
            transform="translate(-110,-60) scale(2)" />

        <g class="">
            <path class="ActionButton"
                fill="#acf" stroke="#fff" stroke-width="2"
                d="M-85,-22
                    a6,6 0,0,1 6,-6 h160 
                    a6,6 0,0,1 6,6 v40
                    a6,6 0,0,1 -6,6 h-160
                    a6,6 0,0,1 -6,-6 z" />
            <text class="ActionText" x="0" y="0">Action</text>
            <path class="MouseCursor"
                fill="#fff" stroke="#222"
                d="M0,0 l10,17 l-7,-2 l3,10 h-12 l3,-10 l-7,2 z"
                transform="translate(45,5) rotate(-40) scale(2)" />
        </g>
    </g>

    <g class="command" transform="translate(700,140)">
        <path class="commandArrow" style="filter:url(#dropshadow)"
            fill="#fca" stroke="#222" stroke-width="2"
            d="M-150,0
                c-1,-1.66 -.66,-5 1,-6
                c30,-20 145,-60 200,-50
                c2.5,.5 5,-2.5 5,-5 v-30
                c0,-5 3,-8 15,0 l120,80
                c3,2 3,6 0,8 l-120,80
                c-12,8 -15,5 -15,0 v-30
                c0,-2.5 -1,-5 -4.5,-6
                c-53,-7 -120,20 -150,40
                c-1.66,1 -4,.33 -5,-1.33 z"
            transform="rotate(8)" />
        <text class="commandText" x="0" y="0">Command</text>
    </g>

    <g class="server" transform="translate(1050,150)">
        <path class="ServerBox" style="filter:url(#dropshadow)"
            fill="#fff8dc" stroke="#222" stroke-width="1"
            d="M-65,-25 h130 v100 h-130 z
                l15,-15 h130 v100 l-15,15
                m0,-100 l15,-15"
            transform="scale(2)" />

        <path class="ServerFilter"
            fill="#acf" stroke="#222" stroke-width="2"
            d="M-30,-30
                a30,10 0,0,1 60,0 v10 l-25,25 v30 l-10,-10 v-20 l-25,-25 z
                m5,0 a25,6 0,0,0 50,0 a25,6 0,0,0 -50,0"
            transform="translate(-60,80)" />

        <path class="ServerStorage"
            fill="#acf" stroke="#222" stroke-width="2"
            d="M-30,-30 
                a30,10 0,0,1 60,0 v60 
                a30,10 0,0,1 -60,0 z
               m60,0 a30,10 0,0,1 -60,0
               m60,15 a30,10 0,0,1 -60,0
               m60,15 a30,10 0,0,1 -60,0
               m60,15 a30,10 0,0,1 -60,0"
            transform="translate(60,80)" />

        <text class="ServerText" x="0" y="0">Server</text>
    </g>

    <g class="events" transform="translate(1100, 450)">
        <path class="commandArrow" style="filter:url(#dropshadow)"
            fill="#fca" stroke="#222" stroke-width="2"
            d="M-150,0
                c-1,-1.66 -.66,-5 1,-6
                c30,-20 145,-60 200,-50
                c2.5,.5 5,-2.5 5,-5 v-30
                c0,-5 3,-8 15,0 l120,80
                c3,2 3,6 0,8 l-120,80
                c-12,8 -15,5 -15,0 v-30
                c0,-2.5 -1,-5 -4.5,-6
                c-53,-7 -120,20 -150,40
                c-1.66,1 -4,.33 -5,-1.33 z"
            transform="rotate(140)" />
        
        <text class="commandText" x="-50" y="40">Events</text>
    </g>

    <g class="compute" transform="translate(825, 575)">
        <path class="ComputeBox" style="filter:url(#dropshadow)"
            fill="#fff8dc" stroke="#222" stroke-width="2"
            d="M-120,-80 h240 v160 h-240 z" />
        <path class="ComputeSum"
            fill="#acf" stroke="#222" stroke-width="3"
            d="M-55,-65
                h100 l10,40 h-7 l-3,-5 c-8,-14 -10,-20 -32,-20 h-50
                l45,45 l-40,40
                h45 c12,0 24,-4 32,-20 l3,-5 h7 l-12,50 h-98
                v-15 l40,-40 l-40,-40 z"
            transform="scale(0.66) translate(0,30)" />
        
        <text class="ViewText" x="0" y="-50">Computations</text>
    </g>

    <g class="updates" transform="translate(530, 500)">
        <path class="commandArrow" style="filter:url(#dropshadow)" 
            fill="#fca" stroke="#222" stroke-width="2"
            d="M-150,0
                c-1,-1.66 -.66,-5 1,-6
                c30,-20 145,-60 200,-50
                c2.5,.5 5,-2.5 5,-5 v-30
                c0,-5 3,-8 15,0 l120,80
                c3,2 3,6 0,8 l-120,80
                c-12,8 -15,5 -15,0 v-30
                c0,-2.5 -1,-5 -4.5,-6
                c-53,-7 -120,20 -150,40
                c-1.66,1 -4,.33 -5,-1.33 z"
            transform="scale(-1,1) rotate(0)" />
        
        <text class="commandText" x="-20" y="0">Updates</text>
    </g>

    <g class="views" transform="translate(170, 550) scale(1.5)">
        <path class="ViewScreen" style="filter:url(#dropshadow)"
            fill="#fff8dc" stroke="#222" stroke-width="1.33"
            d="M-100,-60 h200 v120 h-200 z
               m4,6 v108 h192 v-108 z
               M-5,60 v10 h-20 v5 h50 v-5 h-20 v-10 z"/>

        <path class="ViewScreenContent"
            fill="#222" d="M-100,-60 m4,6 v108 h192 v-108 z"/>

        <path class="ViewTree"
            fill="#222" stroke="#fff" stroke-width="2.5"
            d="M-50,-50
                m3,0 h10 a3,3 0,0,1 3,3 v10 a3,3 0,0,1 -3,3 h-10 a3,3 0,0,1 -3,-3 v-10 a3,3 0,0,1 3,-3 z
                m0,8 h10
                m10,-6 h60 v12 h-60 z
               M-42,-30 v12 m0,5 v12 m0,5 v12 m0,5 v8 h10
                m5,-8 h10 a3,3 0,0,1 3,3 v10 a3,3 0,0,1 -3,3 h-10 a3,3 0,0,1 -3,-3 v-10 a3,3 0,0,1 3,-3 z
                m0,8 h10 m-5,-5 v10
                m15,-11 h35 v12 h-35 z
               M-42,-24 h10
                m5,-8 h10 a3,3 0,0,1 3,3 v10 a3,3 0,0,1 -3,3 h-10 a3,3 0,0,1 -3,-3 v-10 a3,3 0,0,1 3,-3 z
                m0,8 h10
                m10,-6 h30 v12 h-30 z
               M-22,-12 v12 m0,5 v7 h10
                m5,-6 h25 v12 h-25 z
               M-22,-6 h10
                m5,-6 h40 v12 h-40 z"
            transform="translate(-40,5) scale(0.9)" />

        <path class="ViewGraph"
            fill="#222" stroke="#fff" stroke-width="2.5"
            d="M-40,40 v-50 h20 v50 z
               m25,0 v-70 h20 v70 z
               m25,0 v-60 h20 v60 z"
            transform="translate(50,0)" />
        
        <text class="ViewText" x="0" y="-90">Views</text>
    </g>

    <g class="schema build" transform="translate(700, 360) scale(2)">
        <path class="Oval" style="filter:url(#dropshadow)"
            fill="#fff" stroke="#222" stroke-width="1.33"
            d="M0,-40 m0,10 a100,30 0,0,1 100,30 a100,30 0,0,1 -100,30 a100,30 0,0,1 -100,-30 a100,30 0,0,1 100,-30 m0,70" />
        <!--<ellipse style="filter:url(#dropshadow)"
            fill="#fff" stroke="#222" stroke-width="1.5" 
            cx="0" cy="0" rx="100" ry="30"/>-->
        
        <text class="ViewText" font-weight="bold"
            x="0" y="3">Schema</text>
    </g>
    <g class="build" transform="translate(820, 170) scale(4)">
        <text class="ViewText"
            fill="#729C62" stroke="#222" stroke-width="1">✔</text>
    </g>
    <g class="build" transform="translate(1005, 250) scale(3)">
        <text class="ViewText"
            fill="#729C62" stroke="#222" stroke-width="1">✔</text>
    </g>
    <g class="build" transform="translate(1115, 250) scale(3)">
        <text class="ViewText"
            fill="#729C62" stroke="#222" stroke-width="1">✔</text>
    </g>
    <g class="build" transform="translate(1150, 420) scale(4)">
        <text class="ViewText"
            fill="#729C62" stroke="#222" stroke-width="1">✔</text>
    </g>
    <g class="build" transform="translate(870, 615) scale(3)">
        <text class="ViewText"
            fill="#729C62" stroke="#222" stroke-width="1">✔</text>
    </g>
    <g class="build" transform="translate(630, 520) scale(4)">
        <text class="ViewText"
            fill="#729C62" stroke="#222" stroke-width="1">✔</text>
    </g>
    <g class="build" transform="translate(290, 430) scale(4)">
        <text class="ViewText"
            fill="#729C62" stroke="#222" stroke-width="1">?</text>
    </g>

</svg> 
++++

////
[%build.hd]
* [language-cpp]#`[.token.class-name]##CommandFor##<T>`#
* [language-cpp]#`[.token.class-name]##ComamndValidatorFor##<T>`#
* [language-cpp]#`[.token.class-name]##RepositoryFor##<T>`#
* [language-cpp]#`[.token.class-name]##EventFor##<T>`#
* [language-cpp]#`[.token.class-name]##ComputeFor##<T>`#
* [language-cpp]#`[.token.class-name]##ViewModelFor##<T>`#
////

[.subtitle]
== ViewModels

[.source.hd]
== !

[source%nested, cpp, subs=quotes,macros]
----
// nest++
template&lt;class [.token.black]##T##>
using [.token.class-name]##ViewModelFor## = decltype(
        viewModelFor([.token.constant]##adl##, [.token.constant]##ptr##&lt;T>));
// nest--

// nest++
template&lt;class... Ts>
auto viewModelFor([.token.class-name]##ADL##, [.token.bold]##AllOf##&lt;Ts...> *)
    -> [.token.class-name]##AllOfView##&lt;Ts...>;
// nest--
----

[.source.hd]
== !

[source%nested, cpp, subs=quotes,macros]
----
nest++
template&lt;class... Ts>
class AllOfView : public [.token.class-name]##QObject## {
nest--






};
----

== Woboq Verdigris

[%build]
* Plug in replacement for Qt moc
* Allows templated `[.token.class-name]##QObject##`
* link:https://github.com/woboq/verdigris[github.com/woboq/verdigris]
* PR#69 adds "ConstExpr C++ API"

&nbsp;

[.cue]
****
Moc Compiler would require a lot of work.

Verdigris from Woboq is a huge win.
****


[.source.hd]
== !

[source%nested, cpp, subs=quotes,macros]
----
template&lt;class... Ts>
class AllOfView : public [.token.class-name]##QObject## {
  // nest++
  W_OBJECT(AllOfView)
  // nest--

};

// nest++
W_OBJECT_IMPL([.token.class-name]##AllOfView##&lt;Ts...>,
              template&lt;class... Ts>)
// nest--
----

[.cue]
****
W_OBJECT instead of Q_Object macro.
W_OBJECT_IMPL generates all the code moc would generate.
****

[.source.hd.s77x19]
== !

[.build]
--
[source%nested, cpp, subs=quotes,macros]
----
template&lt;class... Ts>
class AllOfView : public [.token.class-name]##QObject## {

  // nest++
  template&lt;[.token.keyword]##size_t## I,
  // nest++
           class = std::enable_if_t&lt;(I &lt; sizeof...(Ts))>>
  // nest--
  struct RegisterProperties {
    // nest++
    constexpr static auto [.token.constant]##property## = 
    // nest--
      // nest++
      w_cpp::[.token.function]##makeProperty##&lt;[.token.class-name]##QVariant##>(
          [.token.constant]##property_name##&lt;I>, [.token.constant]##qvariant_name##)
        // nest--
        // nest++
        .setGetter(&[.token.class-name]##AllOfView##::[.token.function]##getPropertyValue##&lt;I>)
        .setSetter(&[.token.class-name]##AllOfView##::[.token.function]##setPropertyValue##&lt;I>)
        .setNotify(&[.token.class-name]##AllOfView##::[.token.function]##propertyChanged##&lt;I>);
        // nest--
  };
  // nest--
  // nest++
  W_CPP_PROPERTY([.token.class-name]##RegisterProperties##)
  // nest--

};
----
--

[.cue]
****
To Register the properties we create a templated struct with any name.
We limit I to the amount of properties we have with enable_it_t.
Only the property compile time constant matters.
We build it with a type, a name and the type name.
We also provide how get, set and notify works for the property.
Finally we give that struct to Verdigris.

That's the pattern.

****

== !


++++
<!-- for editing help:
 * https://editor.method.ac
 * https://svg-edit.github.io/svgedit/releases/latest/editor/svg-editor.html
-->
<svg class="" viewBox="0 0 1280 720" width="1920" height="1080">

    <g class="clientMonitor" transform="translate(350,180) scale(1.5)">
        <g class="">
            <path class="UserScreen" style="filter:url(#dropshadow)" 
                fill="#fff8dc" stroke="#222" stroke-width="1.33"
                d="M-100,-60 h200 v120 h-200 z
                m4,6 v108 h192 v-108 z
                M-110,80 h5 
                    v-3 h12 v3 h3 
                    v-3 h7 v3 h3 
                    v-3 h7 v3 h3 
                    v-3 h7 v3 h3 
                    v-3 h7 v3 h3 
                    v-3 h7 v3 h3 
                    v-3 h7 v3 h3 
                    v-3 h7 v3 h3 
                    v-3 h7 v3 h3 
                    v-3 h7 v3 h3 
                    v-3 h7 v3 h3 
                    v-3 h7 v3 h3 
                    v-3 h12 v3 
                    h5 v5 H-110 z
                M60,70 h30 v30 c0,7 -7,15 -15,15 c-8,0 -15,-8 -15,-15 z m15,0 v15"/>

            <path class="UserScreenContent"
                fill="#222" d="M-100,-60 m4,6 v108 h192 v-108 z"/>
        </g>

        <path class="UserSmiley"
            fill="#ddc" stroke="#222" stroke-width="0.66"
            d="M0,-20 a20,20 0,0,0, 0,40 a20,20 0,0,0, 0,-40z 
                m-15,25 a16,10 0,0,0, 30,0
                m-7,-13 a3,3 0,1,0, 1,0 z
                m-16,0 a3,3 0,1,0, 1,0 z
                m8,-7 l8,-10 m-9,10 l2,-9"
            transform="translate(-110,-60) scale(2)" />

        <g class="">
            <path class="ActionButton"
                fill="#acf" stroke="#fff" stroke-width="2"
                d="M-85,-22
                    a6,6 0,0,1 6,-6 h160 
                    a6,6 0,0,1 6,6 v40
                    a6,6 0,0,1 -6,6 h-160
                    a6,6 0,0,1 -6,-6 z" />
            <text class="ActionText" x="0" y="0">Action</text>
            <path class="MouseCursor"
                fill="#fff" stroke="#222"
                d="M0,0 l10,17 l-7,-2 l3,10 h-12 l3,-10 l-7,2 z"
                transform="translate(45,5) rotate(-40) scale(2)" />
        </g>
    </g>

    <g class="command" transform="translate(700,140)">
        <path class="commandArrow" style="filter:url(#dropshadow)"
            fill="#fca" stroke="#222" stroke-width="2"
            d="M-150,0
                c-1,-1.66 -.66,-5 1,-6
                c30,-20 145,-60 200,-50
                c2.5,.5 5,-2.5 5,-5 v-30
                c0,-5 3,-8 15,0 l120,80
                c3,2 3,6 0,8 l-120,80
                c-12,8 -15,5 -15,0 v-30
                c0,-2.5 -1,-5 -4.5,-6
                c-53,-7 -120,20 -150,40
                c-1.66,1 -4,.33 -5,-1.33 z"
            transform="rotate(8)" />
        <text class="commandText" x="0" y="0">Command</text>
    </g>

    <g class="server" transform="translate(1050,150)">
        <path class="ServerBox" style="filter:url(#dropshadow)"
            fill="#fff8dc" stroke="#222" stroke-width="1"
            d="M-65,-25 h130 v100 h-130 z
                l15,-15 h130 v100 l-15,15
                m0,-100 l15,-15"
            transform="scale(2)" />

        <path class="ServerFilter"
            fill="#acf" stroke="#222" stroke-width="2"
            d="M-30,-30
                a30,10 0,0,1 60,0 v10 l-25,25 v30 l-10,-10 v-20 l-25,-25 z
                m5,0 a25,6 0,0,0 50,0 a25,6 0,0,0 -50,0"
            transform="translate(-60,80)" />

        <path class="ServerStorage"
            fill="#acf" stroke="#222" stroke-width="2"
            d="M-30,-30 
                a30,10 0,0,1 60,0 v60 
                a30,10 0,0,1 -60,0 z
               m60,0 a30,10 0,0,1 -60,0
               m60,15 a30,10 0,0,1 -60,0
               m60,15 a30,10 0,0,1 -60,0
               m60,15 a30,10 0,0,1 -60,0"
            transform="translate(60,80)" />

        <text class="ServerText" x="0" y="0">Server</text>
    </g>

    <g class="events" transform="translate(1100, 450)">
        <path class="commandArrow" style="filter:url(#dropshadow)"
            fill="#fca" stroke="#222" stroke-width="2"
            d="M-150,0
                c-1,-1.66 -.66,-5 1,-6
                c30,-20 145,-60 200,-50
                c2.5,.5 5,-2.5 5,-5 v-30
                c0,-5 3,-8 15,0 l120,80
                c3,2 3,6 0,8 l-120,80
                c-12,8 -15,5 -15,0 v-30
                c0,-2.5 -1,-5 -4.5,-6
                c-53,-7 -120,20 -150,40
                c-1.66,1 -4,.33 -5,-1.33 z"
            transform="rotate(140)" />
        
        <text class="commandText" x="-50" y="40">Events</text>
    </g>

    <g class="compute" transform="translate(825, 575)">
        <path class="ComputeBox" style="filter:url(#dropshadow)"
            fill="#fff8dc" stroke="#222" stroke-width="2"
            d="M-120,-80 h240 v160 h-240 z" />
        <path class="ComputeSum"
            fill="#acf" stroke="#222" stroke-width="3"
            d="M-55,-65
                h100 l10,40 h-7 l-3,-5 c-8,-14 -10,-20 -32,-20 h-50
                l45,45 l-40,40
                h45 c12,0 24,-4 32,-20 l3,-5 h7 l-12,50 h-98
                v-15 l40,-40 l-40,-40 z"
            transform="scale(0.66) translate(0,30)" />
        
        <text class="ViewText" x="0" y="-50">Computations</text>
    </g>

    <g class="updates" transform="translate(530, 500)">
        <path class="commandArrow" style="filter:url(#dropshadow)" 
            fill="#fca" stroke="#222" stroke-width="2"
            d="M-150,0
                c-1,-1.66 -.66,-5 1,-6
                c30,-20 145,-60 200,-50
                c2.5,.5 5,-2.5 5,-5 v-30
                c0,-5 3,-8 15,0 l120,80
                c3,2 3,6 0,8 l-120,80
                c-12,8 -15,5 -15,0 v-30
                c0,-2.5 -1,-5 -4.5,-6
                c-53,-7 -120,20 -150,40
                c-1.66,1 -4,.33 -5,-1.33 z"
            transform="scale(-1,1) rotate(0)" />
        
        <text class="commandText" x="-20" y="0">Updates</text>
    </g>

    <g class="views" transform="translate(170, 550) scale(1.5)">
        <path class="ViewScreen" style="filter:url(#dropshadow)"
            fill="#fff8dc" stroke="#222" stroke-width="1.33"
            d="M-100,-60 h200 v120 h-200 z
               m4,6 v108 h192 v-108 z
               M-5,60 v10 h-20 v5 h50 v-5 h-20 v-10 z"/>

        <path class="ViewScreenContent"
            fill="#222" d="M-100,-60 m4,6 v108 h192 v-108 z"/>

        <path class="ViewTree"
            fill="#222" stroke="#fff" stroke-width="2.5"
            d="M-50,-50
                m3,0 h10 a3,3 0,0,1 3,3 v10 a3,3 0,0,1 -3,3 h-10 a3,3 0,0,1 -3,-3 v-10 a3,3 0,0,1 3,-3 z
                m0,8 h10
                m10,-6 h60 v12 h-60 z
               M-42,-30 v12 m0,5 v12 m0,5 v12 m0,5 v8 h10
                m5,-8 h10 a3,3 0,0,1 3,3 v10 a3,3 0,0,1 -3,3 h-10 a3,3 0,0,1 -3,-3 v-10 a3,3 0,0,1 3,-3 z
                m0,8 h10 m-5,-5 v10
                m15,-11 h35 v12 h-35 z
               M-42,-24 h10
                m5,-8 h10 a3,3 0,0,1 3,3 v10 a3,3 0,0,1 -3,3 h-10 a3,3 0,0,1 -3,-3 v-10 a3,3 0,0,1 3,-3 z
                m0,8 h10
                m10,-6 h30 v12 h-30 z
               M-22,-12 v12 m0,5 v7 h10
                m5,-6 h25 v12 h-25 z
               M-22,-6 h10
                m5,-6 h40 v12 h-40 z"
            transform="translate(-40,5) scale(0.9)" />

        <path class="ViewGraph"
            fill="#222" stroke="#fff" stroke-width="2.5"
            d="M-40,40 v-50 h20 v50 z
               m25,0 v-70 h20 v70 z
               m25,0 v-60 h20 v60 z"
            transform="translate(50,0)" />
        
        <text class="ViewText" x="0" y="-90">Views</text>
    </g>

    <g class="schema" transform="translate(700, 360) scale(2)">
        <path class="Oval" style="filter:url(#dropshadow)"
            fill="#fff" stroke="#222" stroke-width="1.33"
            d="M0,-40 m0,10 a100,30 0,0,1 100,30 a100,30 0,0,1 -100,30 a100,30 0,0,1 -100,-30 a100,30 0,0,1 100,-30 m0,70" />
        <!--<ellipse style="filter:url(#dropshadow)"
            fill="#fff" stroke="#222" stroke-width="1.5" 
            cx="0" cy="0" rx="100" ry="30"/>-->
        
        <text class="ViewText" font-weight="bold"
            x="0" y="3">Schema</text>
    </g>
    <g class="" transform="translate(820, 170) scale(4)">
        <text class="ViewText"
            fill="#729C62" stroke="#222" stroke-width="1">✔</text>
    </g>
    <g class="" transform="translate(1005, 250) scale(3)">
        <text class="ViewText"
            fill="#729C62" stroke="#222" stroke-width="1">✔</text>
    </g>
    <g class="" transform="translate(1115, 250) scale(3)">
        <text class="ViewText"
            fill="#729C62" stroke="#222" stroke-width="1">✔</text>
    </g>
    <g class="" transform="translate(1150, 420) scale(4)">
        <text class="ViewText"
            fill="#729C62" stroke="#222" stroke-width="1">✔</text>
    </g>
    <g class="" transform="translate(870, 615) scale(3)">
        <text class="ViewText"
            fill="#729C62" stroke="#222" stroke-width="1">✔</text>
    </g>
    <g class="" transform="translate(630, 520) scale(4)">
        <text class="ViewText"
            fill="#729C62" stroke="#222" stroke-width="1">✔</text>
    </g>
    <g class="build" transform="translate(290, 430) scale(4)">
        <text class="ViewText"
            fill="#729C62" stroke="#222" stroke-width="1">✔</text>
    </g>

</svg> 
++++


== Recap

[%build]
* distributed system
* strong types
* data schemas
* generate code
* build QObjects

&nbsp;


== &plus;+ Advantages &plus;+ &nbsp;

[%build]
* central schema definition
* tailored to domain
* split up data and logic
* very good testability

== \-- Disadvantages \--

[%build]
* uncommon + learning curve
* C++ requires some boilerplate
* long type names

== Links

[%build]
* link:https://github.com/woboq/verdigris[github.com/woboq/verdigris]
* link:https://github.com/basicpp17[github.com/basicpp17]
* link:https://github.com/arBmind/2019-types-en[github.com/arBmind/2019-types-en]

== !

image::andreas.png[role="center", width="400"]

&nbsp;

[%build]
* Andreas Reischuck
* @*arBmind*

[.cue]
****
Schulungen

C++ - Qt - Clean Code
****

== !

image::hicknhackLogo_new_text.png[role="center", width="400"]

&nbsp;

[.green]_Work_ with us…

[.cue]
****
* C++ Qt UIs
* Dresden
****

== !

image::cppug.png[role="pull-right", width="550"]

&nbsp;

Give a [.green]*Talk* +
=> get a *Dresden* tour

[.cue]
****
* Video Recording
* personal city tour
* I visit your local usergroup
****

== !

image::rebuild_logo.png[role="pull-left", width="450"]

*Rebuild* language project

[.bigger]
&nbsp;

[.center]
[.green]__Collaborate__

[.cue]
****
* improved language & tools for everybody
* Compiler built with C++17
****

== Try out *more*!

== Try out *Type* Driven *Development*!

== Photo Credits

[.small]
* link:https://www.flickr.com/photos/purpleseadonkey/4775066884[Explosion] link:https://creativecommons.org/licenses/by/2.0/[(cc-by-license)]

[.subtitle]
== Thank you!

[language-cpp]#`co_await question_ready()`#

== Opaque Strong Types

[.source.hd.s77x19]
== !

[.build]
--
[source%nested, cpp, subs=quotes,macros]
----
// nest++
// nest++
struct PersonId;
// nest--
// nest++
constexpr auto makeOpaque(Strong&lt;int, struct PersonIdTag>)
    -> PersonId;
// nest--

struct PersonId : Strong&lt;int, struct PersonIdTag> {
    // nest++
    using Strong::Strong;
    // nest--
};
// nest--
----
--

[.source.hd.s77x19]
== !

[.build]
--
[source%nested, cpp]
----
#define STRONG_OPAQUE(name, type, ...)                   \
  struct name;                                           \
  constexpr auto makeOpaqueType(Strong<                  \
      type, name##Tag, ##__VA_ARGS__>) -> name;          \
  struct name : Strong<type, name##Tag, ##__VA_ARGS__> { \
      using Strong::Strong;                              \
  }

STRONG_OPAQUE(PersonId, int);
----
--
